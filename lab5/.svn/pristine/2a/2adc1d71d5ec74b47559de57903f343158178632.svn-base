#include <stdarg.h> // va_* macros are defined here
#include <stdint.h>
#include <stdio.h>
#include <minix/driver.h>
#include <lcom/lcf.h>
#include <sys/mman.h>
#include <stdio.h>
#include "sprite.h"
#include "graphic.h"
/** Creates a new sprite with pixmap "pic", with specified
* position (within the screen limits) and speed;
* Does not draw the sprite on the screen
* Returns NULL on invalid pixmap.
*/
Sprite *create_sprite(xpm_map_t xpm, int x, int y,int xspeed, int yspeed) {
    //allocate space for the "object"
    Sprite *sp = (Sprite *) malloc ( sizeof(Sprite));
    if( sp == NULL )
    return NULL;

    // read the sprite pixmap
    xpm_image_t img;
    sp->map = xpm_load(xpm, XPM_INDEXED, &img); 
    
    sp->x = x; 
    sp->y = y; 
    sp->xspeed= xspeed; 
    sp->yspeed= yspeed;

    sp->width = img.width;
    sp->height= img.height;

     

    if( sp->map == NULL ) {
    free(sp);
    return NULL;
    }


    return sp;
}

void destroy_sprite(Sprite *sp) {
    if( sp == NULL )
    return;
    
    if( sp ->map )
        free(sp->map);
    
    free(sp);
    sp = NULL; // XXX: pointer is passed by value
    // should do this @ the caller
}


Sprite* SpriteInit(xpm_map_t xpm,uint16_t *xi,uint16_t *xf,uint16_t *yi,uint16_t *yf,int16_t speed,uint16_t *required){
    Sprite * res;
    int movementX;
    int movementY;
    if (speed > 0){
        if (yi == yf){
            movementX = absO(speed)/(abs(*xf -*xi)/(*xf-*xi));
            movementY = 0;   
        }
        else{
            printf("PAROU 1\n");
            movementY = absO(speed)/(abs((int)*yf -*yi)/(*yf-*yi)); 
            printf("PAROU 2\n");
            movementX = 0;
            printf("PAROU 3\n");
        }
        *required = 0;
        printf("PAROU 4\n");
    }         
    else{ 
        printf("PAROU 5\n");
        if (yi == yf){
            printf("PAROU 6\n");
            movementX = absO(speed)/(abs(*xf -*xi)/(*xf-*xi));
            printf("PAROU 7\n");
            movementY = 0;   
        }
        else{
            printf("PAROU 8\n");
            movementY = absO(speed)/(abs(*yf -*yi)/(*yf-*yi));
            printf("PAROU 9\n"); 
            movementX = 0;
        }
        printf("PAROU 10\n");
        *required = absO(speed);
    }
    printf("PAROU 11\n");
    res = create_sprite(xpm,*xi,*yi,movementX,movementY);
    printf("PAROU 12\n");
    return res;
}

int animate(xpm_map_t xpm,Sprite *sp,uint16_t xf,uint16_t yf,uint16_t required,uint16_t *frame){
    if(*frame < required) return 1;
    *frame = 0;
    int speedX = sp->xspeed;
    int speedY = sp->yspeed;
    sp->x+=speedX;
    sp->y+=speedY;
    if(speedX > 0 && sp->x >= xf) {
        sp->x = xf;
        sp->y = yf;
    }
    else if(speedY > 0 && sp->y >= yf){
        sp->x = xf;
        sp->y = yf;
    }
    else if(speedX < 0 && sp->x <= xf) {
        sp->x = xf;
        sp->y = yf;
     }
    else if(speedY < 0 && sp->y <= yf ) {
        sp->x = xf;
        sp->y = yf;
    }
    drawXpm(xpm,sp->x,sp->y);
    return 0;
}
