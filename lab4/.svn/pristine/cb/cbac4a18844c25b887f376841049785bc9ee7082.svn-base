#include "mouse.h"
#include <lcom/lcf.h>
#include "i8042.h"
#include <stdint.h>
#include <stdio.h>

extern uint16_t byteArray[3];
extern uint32_t data;
extern int counter; 
int mouse_hook_id = 12;

int mouse_subscribe_int(int *bit_no)
{
  (*bit_no) = BIT(mouse_hook_id);
  if (sys_irqsetpolicy(IRQ_MOUSE, IRQ_REENABLE | IRQ_EXCLUSIVE, &mouse_hook_id) != 0) return 1;
  return 0;
}

int mouse_unsubscribe_int()
{
  if (sys_irqrmpolicy(&mouse_hook_id) != 0) return 1;
  return 0;
}

void(mouse_ih)(void)
{
  mouse_read(); 
}

int mouse_read(){
  uint32_t status; 
  for (int i = 0; i< 20; i++){
    if(sys_inb(STAT_REG, &status) != OK ) continue;
    if (!(status & OB_FULL)) continue; 
    if ((status & (TIMOUT_ERROR|PRT_ERROR))) continue; 
    if (sys_inb(BUF_OUT, &data) != OK ) continue; 
    return 0; 
  }
  return 1;
}

void parsePacket()
{
  for (int i = 0; i< 3; i++)
    pp.bytes[i] = byteArray[i]; 

  pp.lb = (byteArray[0]&LB) ? true: false; 
  pp.rb = (byteArray[0]&RB) ? true: false;
  pp.mb = (byteArray[0]&MB) ? true: false;
  pp.x_ov = (byteArray[0]&X_OV) ? true: false;
  pp.y_ov = (byteArray[0]&Y_OV) ? true: false;
  pp.delta_x = (byteArray[0]&X_NEG) ? byteArray[1] - 256: byteArray[1];
  pp.delta_y = (byteArray[0]&Y_NEG) ? byteArray[1] - 256: byteArray[1];
}

int issueCommand(unsigned long cmd)
{
  uint32_t status, byt;

  do
  {
    if (sys_inb(STAT_REG, &status) != OK)
      return -1;

    if ((status & IBF_FULL) == 0)
    {

      if (sys_outb(CMD_REG, CMD_INIT) != OK)
        return -1;
    }
    else
      continue;

    if (sys_inb(STAT_REG, &status) != OK)
      return -1;

    if ((status & IBF_FULL) == 0)
    {
      if (sys_outb(BUF_OUT, cmd) != OK)
        return -1;
    }
    else
      continue;

    tickdelay(micros_to_ticks(DELAY_US));

    if (sys_inb(BUF_OUT, &byt) != OK)
      return -1;

  } while (byt != ACK);

  return 0;
}

void handleSync(){
  if ((data & BIT(3)) && counter == 0)
      {
        byteArray[0] = data;
        counter++; 
      }

  else if (counter == 1)
    {
      byteArray[1] = data;
      counter++; 
    }

    else if (counter == 2)
    {
      byteArray[2] = data;
      counter++;
    }

}
